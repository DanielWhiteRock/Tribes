(function($){$('body').on('submit','.gamipress-purchases-form',function(e){e.preventDefault();return!1});$('body').on('keypress','.gamipress-purchases-form',function(e){return e.keyCode!=13});$('body').on('click','.gamipress-purchases-form .gamipress-purchases-form-submit-button',function(e){e.preventDefault();var $this=$(this);var form=$(this).closest('.gamipress-purchases-form');var acceptance_input=form.find('.gamipress-purchases-form-acceptance-input');var submit_wrap=form.find('.gamipress-purchases-form-submit');if(submit_wrap.find('.gamipress-purchases-form-response').length===0){submit_wrap.prepend('<div class="gamipress-purchases-form-response" style="display: none;"></div>')}
var response_wrap=submit_wrap.find('.gamipress-purchases-form-response');if(acceptance_input.length&&!acceptance_input.prop('checked')){response_wrap.addClass('gamipress-purchases-error');response_wrap.html(gamipress_purchases.acceptance_error);response_wrap.slideDown();return}
$this.prop('disabled',!0);if(response_wrap.length){response_wrap.slideUp()}
submit_wrap.find('.gamipress-spinner').show();form.trigger('gamipress_purchases_before_purchase_request');$.ajax({url:gamipress_purchases.ajaxurl,method:'POST',data:form.serialize()+'&action=gamipress_purchases_process_purchase',success:function(response){response_wrap.addClass('gamipress-purchases-'+(response.success===!0?'success':'error'));response_wrap.html((response.data.message!==undefined?response.data.message:response.data));response_wrap.slideDown();if(response.success!==!0){$this.prop('disabled',!1)}
submit_wrap.find('.gamipress-spinner').hide();form.trigger('gamipress_purchases_purchase_'+(response.success===!0?'success':'error'));form.trigger('gamipress_purchases_after_purchase_request');if(response.data.redirect===!0&&response.data.redirect_url!==undefined&&response.data.redirect_url.length){window.location.href=response.data.redirect_url}},error:function(response){form.trigger('gamipress_purchases_purchase_error');form.trigger('gamipress_purchases_after_purchase_request')}})});$('body').on('change keyup','.gamipress-purchases-form-custom-amount',function(){var form=$(this).closest('.gamipress-purchases-form');var type=form.find('input[name="amount_type"]').val();var value_str=$(this).val();var value=parseFloat($(this).val());var points_type=form.find('input[name="points_type"]').val();var preview=$(this).siblings('.gamipress-purchases-form-custom-preview');var points_total=0;var subtotal=0;var converted_value=0;if(value_str===''||isNaN(value_str)){value=0}
if(type==='points'){converted_value=gamipress_purchases_convert_to_money(value,points_type);points_total=value;subtotal=converted_value;form.find('input[name="amount"]').val(points_total);preview.html(gamipress_purchases_format_price(subtotal))}else{converted_value=gamipress_purchases_convert_to_points(value,points_type);points_total=converted_value;subtotal=value;form.find('input[name="amount"]').val(subtotal);preview.html(points_total)}
form.find('.gamipress-purchases-form-subtotal-amount').html(gamipress_purchases_format_price(subtotal));form.find('.gamipress-purchases-form-points-total-amount').html(points_total);form.find('input[name="subtotal"]').val(subtotal);form.find('.gamipress-purchases-form-country-select').trigger('change')});$('body').on('change','.gamipress-purchases-form-option input',function(){var target=$(this).closest('.gamipress-purchases-form-options').find('.gamipress-purchases-form-options-custom-amount');if($(this).val()==='custom'){target.find('input').trigger('change');target.slideDown()}else{target.slideUp();var form=$(this).closest('.gamipress-purchases-form');var type=form.find('input[name="amount_type"]').val();var value_str=$(this).val();var value=parseFloat($(this).val());var points_type=form.find('input[name="points_type"]').val();var converted_value=0;var points_total=0;var subtotal=0;if(value_str===''||isNaN(value_str)){value=0}
if(type==='points'){converted_value=gamipress_purchases_convert_to_money(value,points_type);points_total=value;subtotal=converted_value;form.find('input[name="amount"]').val(points_total)}else{converted_value=gamipress_purchases_convert_to_points(value,points_type);points_total=converted_value;subtotal=value;form.find('input[name="amount"]').val(subtotal)}
form.find('.gamipress-purchases-form-subtotal-amount').html(gamipress_purchases_format_price(subtotal));form.find('.gamipress-purchases-form-points-total-amount').html(points_total);form.find('input[name="subtotal"]').val(subtotal);form.find('.gamipress-purchases-form-country-select').trigger('change')}});$('.gamipress-purchases-form-option input:checked').trigger('change');$('body').on('change keyup','.gamipress-purchases-form-options-custom-amount-input',function(){var form=$(this).closest('.gamipress-purchases-form');var type=form.find('input[name="amount_type"]').val();var value_str=$(this).val();var value=parseFloat($(this).val());var points_type=form.find('input[name="points_type"]').val();var converted_value=0;var points_total=0;var subtotal=0;if(value_str===''||isNaN(value_str)){value=0}
if(type==='points'){converted_value=gamipress_purchases_convert_to_money(value,points_type);points_total=value;subtotal=converted_value;form.find('input[name="amount"]').val(points_total)}else{converted_value=gamipress_purchases_convert_to_points(value,points_type);points_total=converted_value;subtotal=value;form.find('input[name="amount"]').val(subtotal)}
form.find('.gamipress-purchases-form-subtotal-amount').html(gamipress_purchases_format_price(subtotal));form.find('.gamipress-purchases-form-points-total-amount').html(points_total);form.find('input[name="subtotal"]').val(subtotal);form.find('.gamipress-purchases-form-country-select').trigger('change')});$('body').on('change','.gamipress-purchases-form-country-select, .gamipress-purchases-form-state-input, .gamipress-purchases-form-postcode-input',function(){var form=$(this).closest('.gamipress-purchases-form');var country=form.find('.gamipress-purchases-form-country-select').val();var state=form.find('.gamipress-purchases-form-state-input').val();var postcode=form.find('.gamipress-purchases-form-postcode-input').val();var subtotal=parseFloat(form.find('input[name="subtotal"]').val());var tax_rate=gamipress_purchases_get_tax_rate(country,state,postcode);var tax=tax_rate*100;var tax_amount=subtotal*tax_rate;var total=tax_amount+subtotal;form.find('.gamipress-purchases-form-tax-amount').html(gamipress_purchases_format_price(tax_amount));form.find('.gamipress-purchases-form-tax-percent').html('('+tax+'%)');form.find('.gamipress-purchases-form-total-amount').html(gamipress_purchases_format_price(total));form.find('input[name="tax_amount"]').val(tax_amount);form.find('input[name="tax"]').val(tax);form.find('input[name="total"]').val(total)});$('body').on('change','.gamipress-purchases-form-gateway-option input',function(){var form=$(this).closest('.gamipress-purchases-form');form.find('.gamipress-purchases-form-gateway-form').hide();form.find('.gamipress-purchases-form-gateway-form.gamipress-purchases-form-gateway-'+$(this).val()+'-form').show()});$('.gamipress-purchases-form-gateway-option input:checked').trigger('change')})(jQuery)