(function($){var prefix='gamipress-wc-partial-payments-';$('body').on('click','.'+prefix+'form-toggle a',function(e){e.preventDefault();$('.'+prefix+'form').slideToggle()});$('body').on('input','.'+prefix+'points',function(e){var $this=$(this);$('#'+$this.attr('id')+'-preview').text($this.val())});$('body').on('change input','.'+prefix+'points',function(e){gamipress_wc_partial_payments_update_preview()});$('body').on('change','#'+prefix+'points-type',function(e){var $this=$(this);var points_type=$this.val();$('.'+prefix+'points-label').hide();$('.'+prefix+'points-preview').hide();$('.'+prefix+'points').hide();$('.'+prefix+'points-balance').hide();$('label[for="'+prefix+'points-'+points_type+'"]').show();$('#'+prefix+'points-'+points_type+'-preview').show();$('#'+prefix+'points-'+points_type).show();$('#'+prefix+'points-'+points_type+'-balance').show();gamipress_wc_partial_payments_update_preview()});$('body').on('click','#gamipress-wc-partial-payments button[name="apply_partial_payment"]',function(e){e.preventDefault();var $this=$(this);var $form=$this.closest('.'+prefix+'form');var notices_wrapper=$('.gamipress-wc-partial-payments-notices');gamipress_wc_partial_payments_block($form);$.ajax({url:gamipress_wc_partial_payments.ajaxurl,method:'POST',data:$form.serialize()+'&action=gamipress_wc_partial_payments_apply_partial_payment'+'&nonce='+gamipress_wc_partial_payments.nonce,success:function(response){notices_wrapper.find('.woocommerce-error, .woocommerce-message, .woocommerce-info').remove();if(response.success===!1){gamipress_wc_partial_payments_show_notice('<div class="woocommerce-error" role="alert">'+response.data+'</div>',notices_wrapper)}else{gamipress_wc_partial_payments_show_notice('<div class="woocommerce-message" role="alert">'+response.data+'</div>',notices_wrapper);gamipress_wc_partial_payments_update_cart(!0)}},error:function(response){notices_wrapper.find('.woocommerce-error, .woocommerce-message, .woocommerce-info').remove();gamipress_wc_partial_payments_show_notice('<div class="woocommerce-error" role="alert">'+response.data+'</div>',notices_wrapper)},complete:function(){gamipress_wc_partial_payments_unblock($form)}})});$('body').on('click','.gamipress-wc-partial-payments-remove',function(e){e.preventDefault();var $this=$(this);var $wrapper=$this.closest('.cart_totals');var notices_wrapper=$('.gamipress-wc-partial-payments-notices');if(!$wrapper.length)
$wrapper=$this.closest('.shop_table');gamipress_wc_partial_payments_block($wrapper);$.ajax({url:gamipress_wc_partial_payments.ajaxurl,method:'POST',data:{action:'gamipress_wc_partial_payments_remove_partial_payment',nonce:gamipress_wc_partial_payments.nonce,points_type:$this.data('points-type')},success:function(response){notices_wrapper.find('.woocommerce-error, .woocommerce-message, .woocommerce-info').remove();if(response.success===!1){gamipress_wc_partial_payments_show_notice('<div class="woocommerce-error" role="alert">'+response.data+'</div>',notices_wrapper)}else{$this.closest('tr').slideUp('fast');gamipress_wc_partial_payments_show_notice('<div class="woocommerce-message" role="alert">'+response.data+'</div>',notices_wrapper);gamipress_wc_partial_payments_update_cart(!0)}},error:function(response){notices_wrapper.find('.woocommerce-error, .woocommerce-message, .woocommerce-info').remove();gamipress_wc_partial_payments_show_notice('<div class="woocommerce-error" role="alert">'+response.data+'</div>',notices_wrapper)},complete:function(){gamipress_wc_partial_payments_unblock($wrapper)}})});function gamipress_wc_partial_payments_update_preview(){var $form=$('.'+prefix+'form');var points_type=$form.find('*[name="points_type"]').val();var points_type_label=gamipress_wc_partial_payments.points_types[points_type].plural_name;var points=$form.find('*[name="'+points_type+'_points"]').val();$('.'+prefix+'preview-points').text(points);$('.'+prefix+'preview-points-type').text(points_type_label);var money=gamipress_wc_partial_payments_convert_to_money(points,points_type);var decimals=gamipress_wc_partial_payments.decimals;var decimal_separator=gamipress_wc_partial_payments.decimal_separator;var thousand_separator=gamipress_wc_partial_payments.thousand_separator;money=gamipress_wc_partial_payments_number_format(money,decimals,decimal_separator,thousand_separator);$('.'+prefix+'preview-money').text(money)}
function gamipress_wc_partial_payments_get_conversion(points_type){if(gamipress_wc_partial_payments.points_types[points_type]===undefined)
return!1;points_type=gamipress_wc_partial_payments.points_types[points_type];return points_type.conversion}
function gamipress_wc_partial_payments_convert_to_money(amount,points_type=''){var conversion=gamipress_wc_partial_payments_get_conversion(points_type);if(!conversion)return 0;var conversion_rate=conversion.money/conversion.points;return amount*conversion_rate}
function gamipress_wc_partial_payments_number_format(number,decimals,decimal_separator,thousand_separator){decimals=Math.abs(decimals);decimals=isNaN(decimals)?2:decimals;var sign=number<0?"-":"";number=Math.abs(Number(number)||0);var string_number=parseInt(number.toFixed(decimals)).toString();var thousands=(string_number.length>3)?string_number.length%3:0;return sign+(thousands?string_number.substr(0,thousands)+thousand_separator:'')+string_number.substr(thousands).replace(/(\d{3})(?=\d)/g,"$1"+thousand_separator)+(decimals?decimal_separator+Math.abs(number-string_number).toFixed(decimals).slice(2):"")}
function gamipress_wc_partial_payments_block($form){$form.addClass('processing').block({message:null,overlayCSS:{background:'#fff',opacity:0.6}})}
function gamipress_wc_partial_payments_unblock($form){$form.removeClass('processing').unblock()}
function gamipress_wc_partial_payments_update_cart(preserve_notices){var $form=$('.woocommerce-cart-form');gamipress_wc_partial_payments_block($form);gamipress_wc_partial_payments_block($('div.cart_totals'));$.ajax({type:$form.attr('method'),url:$form.attr('action'),data:$form.serialize(),dataType:'html',success:function(response){gamipress_wc_partial_payments_update_wc_div(response,preserve_notices)},complete:function(){gamipress_wc_partial_payments_unblock($form);gamipress_wc_partial_payments_unblock($('div.cart_totals'));$.scroll_to_notices($('[role="alert"]'))}})}
function gamipress_wc_partial_payments_update_wc_div(html_str,preserve_notices){var $html=$.parseHTML(html_str);var $new_form=$('.woocommerce-cart-form',$html);var $new_totals=$('.cart_totals',$html);var $notices=$('.woocommerce-error, .woocommerce-message, .woocommerce-info',$html);if($('.woocommerce-cart-form').length===0){window.location.reload();return}
if(!preserve_notices){$('.woocommerce-error, .woocommerce-message, .woocommerce-info').remove()}
if($new_form.length===0){if($('.woocommerce-checkout').length){window.location.reload();return}
var $cart_html=$('.cart-empty',$html).closest('.woocommerce');$('.woocommerce-cart-form__contents').closest('.woocommerce').replaceWith($cart_html);if($notices.length>0){gamipress_wc_partial_payments_show_notice($notices)}
$(document.body).trigger('wc_cart_emptied')}else{if($('.woocommerce-checkout').length){$(document.body).trigger('update_checkout')}
$('.woocommerce-cart-form').replaceWith($new_form);$('.woocommerce-cart-form').find(':input[name="update_cart"]').prop('disabled',!0);if($notices.length>0){gamipress_wc_partial_payments_show_notice($notices)}
gamipress_wc_partial_payments_update_cart_totals_div($new_totals)}
$(document.body).trigger('updated_wc_div')}
function gamipress_wc_partial_payments_update_cart_totals_div(html_str){$('.cart_totals').replaceWith(html_str);$(document.body).trigger('updated_cart_totals')}
function gamipress_wc_partial_payments_show_notice(html_element,$target){if(!$target){$target=$('.woocommerce-notices-wrapper:first')||$('.cart-empty').closest('.woocommerce')||$('.woocommerce-cart-form')}
$target.prepend(html_element)}})(jQuery)