(function($){$('body').on('submit','.gamipress-points-payout-form',function(e){e.preventDefault();return!1});$('body').on('keypress','.gamipress-points-payout-form',function(e){return e.keyCode!=13});$('body').on('click','.gamipress-points-payout-form .gamipress-points-payout-form-submit-button',function(e){e.preventDefault();var $this=$(this);var form=$this.closest('.gamipress-points-payout-form');var points_type=form.find('[name="points_type"]').val();var points=parseInt(form.find('input[name="amount"]').val());var submit_wrap=form.find('.gamipress-points-payout-form-submit');var payment_method='';if(submit_wrap.find('.gamipress-points-payout-form-response').length===0){submit_wrap.prepend('<div class="gamipress-points-payout-form-response" style="display: none;"></div>')}
var response_wrap=submit_wrap.find('.gamipress-points-payout-form-response');if(isNaN(points)||points===0){response_wrap.addClass('gamipress-points-payout-error');response_wrap.html(gamipress_points_payouts.points_error);response_wrap.slideDown();return}
if(form.find('.gamipress-points-payout-form-payment-method').length){payment_method=form.find('.gamipress-points-payout-form-payment-method').val();if(payment_method.length===0){response_wrap.addClass('gamipress-points-payout-error');response_wrap.html(gamipress_points_payouts.payment_method_error);response_wrap.slideDown();return}}
$this.prop('disabled',!0);if(response_wrap.length){response_wrap.slideUp()}
submit_wrap.find('.gamipress-spinner').show();$.ajax({url:gamipress_points_payouts.ajaxurl,method:'POST',data:form.serialize()+'&action=gamipress_points_payouts_process_points_payout',success:function(response){response_wrap.addClass('gamipress-points-payouts-'+(response.success===!0?'success':'error'));response_wrap.html((response.data.message!==undefined?response.data.message:response.data));response_wrap.slideDown();if(response.success!==!0){$this.prop('disabled',!1)}
submit_wrap.find('.gamipress-spinner').hide();if(response.data.redirect===!0&&response.data.redirect_url!==undefined&&response.data.redirect_url.length){window.location.href=response.data.redirect_url}},error:function(response){}})});$('body').on('change','.gamipress-points-payout-form-points-type',function(){var points_type=$(this).val();var option=$(this).find('option[value="'+points_type+'"]');var form=$(this).closest('.gamipress-points-payout-form');var amount=form.find('.gamipress-points-payout-form-points-input-'+points_type+' input').val();form.find('.gamipress-points-payout-form-points-input-active').hide().removeClass('gamipress-points-payout-form-points-input-active');form.find('.gamipress-points-payout-form-points-input-'+points_type).show().addClass('gamipress-points-payout-form-points-input-active');form.find('.gamipress-points-payout-points-type-label').text(option.data('plural'));form.find('.gamipress-points-payout-form-current-balance-amount').text(option.data('balance'));gamipress_points_payouts_update_form_totals(form,amount)});$('body').on('change keyup','.gamipress-points-payout-form-points-amount',function(){var form=$(this).closest('.gamipress-points-payout-form');var amount=parseInt($(this).val());if($(this).attr('max')!==undefined&&parseInt($(this).attr('max'))>0){var max=parseInt($(this).attr('max'));if(amount>max){$(this).val(max);amount=max}}
gamipress_points_payouts_update_form_totals(form,amount)});function gamipress_points_payouts_update_form_totals(form,amount){if(isNaN(amount)){amount=0}
var points_type=form.find('[name="points_type"]').val();form.find('.gamipress-points-payout-form-total-amount').text(amount);form.find('input[name="amount"]').val(amount);var money=gamipress_points_payouts_convert_to_money(amount,points_type);var decimals=gamipress_points_payouts.decimals;var decimal_separator=gamipress_points_payouts.decimal_separator;var thousand_separator=gamipress_points_payouts.thousand_separator;money=gamipress_points_payouts_number_format(money,decimals,decimal_separator,thousand_separator);form.find('.gamipress-points-payout-form-total-money').text(money);var current_balance=parseInt(form.find('.gamipress-points-payout-form-current-balance-amount').text());var new_balance_wrap=form.find('.gamipress-points-payout-form-new-balance-amount');var new_balance=current_balance-amount;new_balance_wrap.text(new_balance);if(new_balance>1){new_balance_wrap.removeClass('gamipress-points-payouts-negative').addClass('gamipress-points-payouts-positive')}else{new_balance_wrap.removeClass('gamipress-points-payouts-positive').addClass('gamipress-points-payouts-negative')}
var label_position='after';if(gamipress_points_payouts.points_types[points_type]!==undefined){label_position=gamipress_points_payouts.points_types[points_type].label_position}
if(label_position==='after'){form.find('.gamipress-points-payout-form-total-amount').insertBefore(form.find('.gamipress-points-payout-form-total-points-label'));form.find('.gamipress-points-payout-form-total-amount').after(' ');form.find('.gamipress-points-payout-form-current-balance-amount').insertBefore(form.find('.gamipress-points-payout-form-current-balance-points-label'));form.find('.gamipress-points-payout-form-current-balance-amount').after(' ');form.find('.gamipress-points-payout-form-new-balance-amount').insertBefore(form.find('.gamipress-points-payout-form-new-balance-points-label'));form.find('.gamipress-points-payout-form-new-balance-amount').after(' ')}else if(label_position==='before'){form.find('.gamipress-points-payout-form-total-amount').insertAfter(form.find('.gamipress-points-payout-form-total-points-label'));form.find('.gamipress-points-payout-form-total-amount').before(' ');form.find('.gamipress-points-payout-form-current-balance-amount').insertAfter(form.find('.gamipress-points-payout-form-current-balance-points-label'));form.find('.gamipress-points-payout-form-current-balance-amount').before(' ');form.find('.gamipress-points-payout-form-new-balance-amount').insertAfter(form.find('.gamipress-points-payout-form-new-balance-points-label'));form.find('.gamipress-points-payout-form-new-balance-amount').before(' ')}}
function gamipress_points_payouts_get_conversion(points_type){if(gamipress_points_payouts.points_types[points_type]===undefined)
return!1;points_type=gamipress_points_payouts.points_types[points_type];return points_type.conversion}
function gamipress_points_payouts_convert_to_money(amount,points_type=''){var conversion=gamipress_points_payouts_get_conversion(points_type);if(!conversion)return 0;var conversion_rate=conversion.money/conversion.points;return amount*conversion_rate}
function gamipress_points_payouts_number_format(number,decimals,decimal_separator,thousand_separator){var decimals=isNaN(decimals=Math.abs(decimals))?2:decimals,decimal_separator=decimal_separator==undefined?".":decimal_separator,thousand_separator=thousand_separator==undefined?",":thousand_separator,sign=number<0?"-":"",i=String(parseInt(number=Math.abs(Number(number)||0).toFixed(decimals))),j=(j=i.length)>3?j%3:0;return sign+(j?i.substr(0,j)+thousand_separator:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+thousand_separator)+(decimals?decimal_separator+Math.abs(number-i).toFixed(decimals).slice(2):"")}})(jQuery)